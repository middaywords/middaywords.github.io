<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="bpf verifier (3)如何理解 verifier logs翻了好久源码，终于找到了，比如我们拿 vfsstat.py in bcc 作为例子来分析（为什么选这个呢？因为简单） bpf 程序代码： 12345678static void stats_try_increment(int key) &amp;#123;    stats.atomic_increment(key);&amp;#125;KFUN">
<meta property="og:type" content="article">
<meta property="og:title" content="bpf verifier 3">
<meta property="og:url" content="https://middaywords.github.io/2023/10/26/bpf-verifier-3/index.html">
<meta property="og:site_name" content="Kangjie&#39;s Homepage">
<meta property="og:description" content="bpf verifier (3)如何理解 verifier logs翻了好久源码，终于找到了，比如我们拿 vfsstat.py in bcc 作为例子来分析（为什么选这个呢？因为简单） bpf 程序代码： 12345678static void stats_try_increment(int key) &amp;#123;    stats.atomic_increment(key);&amp;#125;KFUN">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-10-26T14:42:51.000Z">
<meta property="article:modified_time" content="2024-09-15T14:36:43.695Z">
<meta property="article:author" content="Kangjie Xu">
<meta property="article:tag" content="bpf">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>bpf verifier 3</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/11/13/linux-tc-bpf/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/10/18/cilium-maps/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://middaywords.github.io/2023/10/26/bpf-verifier-3/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&text=bpf verifier 3"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&is_video=false&description=bpf verifier 3"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=bpf verifier 3&body=Check out this article: https://middaywords.github.io/2023/10/26/bpf-verifier-3/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&name=bpf verifier 3&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&t=bpf verifier 3"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bpf-verifier-3"><span class="toc-number">1.</span> <span class="toc-text">bpf verifier (3)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-verifier-logs"><span class="toc-number">1.1.</span> <span class="toc-text">如何理解 verifier logs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#examples"><span class="toc-number">1.2.</span> <span class="toc-text">examples</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp1-bound-check"><span class="toc-number">1.2.1.</span> <span class="toc-text">exp1 bound check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp2-pkt-access"><span class="toc-number">1.2.2.</span> <span class="toc-text">exp2: pkt access</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp3-kprobe-pt-regs"><span class="toc-number">1.2.3.</span> <span class="toc-text">exp3: kprobe pt_regs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp4-clang-O0-vs-O2"><span class="toc-number">1.2.4.</span> <span class="toc-text">exp4: clang O0 vs. O2</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        bpf verifier 3
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Kangjie Xu</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-10-26T14:42:51.000Z" class="dt-published" itemprop="datePublished">2023-10-26</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/bpf/" rel="tag">bpf</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="bpf-verifier-3"><a href="#bpf-verifier-3" class="headerlink" title="bpf verifier (3)"></a>bpf verifier (3)</h1><h2 id="如何理解-verifier-logs"><a href="#如何理解-verifier-logs" class="headerlink" title="如何理解 verifier logs"></a>如何理解 verifier logs</h2><p>翻了好久源码，终于找到了，比如我们拿 <code>vfsstat.py</code> in bcc 作为例子来分析（为什么选这个呢？因为简单）</p>
<p>bpf 程序代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">stats_try_increment</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">    stats.atomic_increment(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">KFUNC_PROBE(vfs_write) &#123;</span><br><span class="line">    stats_try_increment(S_WRITE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2204:/home/kanxu# bpftool prog dump xlated id 1570</span><br><span class="line">int kfunc__vmlinux__vfs_write(unsigned long long * ctx):</span><br><span class="line">; KFUNC_PROBE(vfs_write)        &#123; stats_try_increment(S_WRITE); return 0; &#125;</span><br><span class="line">   0: (b7) r1 = 2</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">   1: (63) *(u32 *)(r10 -4) = r1</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">   2: (18) r1 = map[id:334]</span><br><span class="line">   4: (bf) r2 = r10</span><br><span class="line">;</span><br><span class="line">   5: (07) r2 += -4</span><br><span class="line">; return bpf_map_lookup_elem((void *)map, key);</span><br><span class="line">   6: (07) r1 += 272</span><br><span class="line">   7: (61) r0 = *(u32 *)(r2 +0)</span><br><span class="line">   8: (35) if r0 &gt;= 0x6 goto pc+3</span><br><span class="line">   9: (67) r0 &lt;&lt;= 3</span><br><span class="line">  10: (0f) r0 += r1</span><br><span class="line">  11: (05) goto pc+1</span><br><span class="line">  12: (b7) r0 = 0</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">  13: (15) if r0 == 0x0 goto pc+2</span><br><span class="line">  14: (b7) r1 = 1</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">  15: (db) lock *(u64 *)(r0 +0) += r1</span><br><span class="line">; KFUNC_PROBE(vfs_write)        &#123; stats_try_increment(S_WRITE); return 0; &#125;</span><br><span class="line">  16: (b7) r0 = 0</span><br><span class="line">  17: (95) exit</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">func#0 @0</span><br><span class="line">0: R1=ctx(id=0,off=0,imm=0) R10=fp0</span><br><span class="line">; KFUNC_PROBE(vfs_write)        &#123; stats_try_increment(S_WRITE); return 0; &#125;</span><br><span class="line">0: (b7) r1 = 2</span><br><span class="line">1: R1_w=inv2 R10=fp0</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">1: (63) *(u32 *)(r10 -4) = r1</span><br><span class="line">2: R1_w=inv2 R10=fp0 fp-8=mmmm????</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">2: (18) r1 = 0xffff9c7cc9ec3e00</span><br><span class="line">4: R1_w=map_ptr(id=0,off=0,ks=4,vs=8,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">4: (bf) r2 = r10</span><br><span class="line">5: R1_w=map_ptr(id=0,off=0,ks=4,vs=8,imm=0) R2_w=fp0 R10=fp0 fp-8=mmmm????</span><br><span class="line">;</span><br><span class="line">5: (07) r2 += -4</span><br><span class="line">6: R1_w=map_ptr(id=0,off=0,ks=4,vs=8,imm=0) R2_w=fp-4 R10=fp0 fp-8=mmmm????</span><br><span class="line">; return bpf_map_lookup_elem((void *)map, key);</span><br><span class="line">6: (85) call bpf_map_lookup_elem#1</span><br><span class="line">7: R0_w=map_value_or_null(id=1,off=0,ks=4,vs=8,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">7: (15) if r0 == 0x0 goto pc+2</span><br><span class="line"> R0_w=map_value(id=0,off=0,ks=4,vs=8,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">8: R0_w=map_value(id=0,off=0,ks=4,vs=8,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">8: (b7) r1 = 1</span><br><span class="line">9: R0_w=map_value(id=0,off=0,ks=4,vs=8,imm=0) R1_w=inv1 R10=fp0 fp-8=mmmm????</span><br><span class="line">; (&#123; typeof(stats.key) _key = key; typeof(stats.leaf) *_leaf = bpf_map_lookup_elem_(bpf_pseudo_fd(1, -1), &amp;_key); if (_leaf) lock_xadd(_leaf, 1);&#125;);</span><br><span class="line">9: (db) lock *(u64 *)(r0 +0) += r1</span><br><span class="line"> R0_w=map_value(id=0,off=0,ks=4,vs=8,imm=0) R1_w=inv1 R10=fp0 fp-8=mmmm????</span><br><span class="line"> R0_w=map_value(id=0,off=0,ks=4,vs=8,imm=0) R1_w=inv1 R10=fp0 fp-8=mmmm????</span><br><span class="line">10: R0=map_value(id=0,off=0,ks=4,vs=8,imm=0) R1=inv1 R10=fp0 fp-8=mmmm????</span><br><span class="line">; KFUNC_PROBE(vfs_write)        &#123; stats_try_increment(S_WRITE); return 0; &#125;</span><br><span class="line">10: (b7) r0 = 0</span><br><span class="line">11: R0_w=inv0 R1=inv1 R10=fp0 fp-8=mmmm????</span><br><span class="line">11: (95) exit</span><br></pre></td></tr></table></figure>

<p>相关的 log 打印逻辑在 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_check</span><span class="params">(<span class="keyword">struct</span> bpf_verifier_env *env)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">if</span> (env-&gt;<span class="built_in">log</span>.level &amp; BPF_LOG_LEVEL2 ||</span><br><span class="line">		    (env-&gt;<span class="built_in">log</span>.level &amp; BPF_LOG_LEVEL &amp;&amp; do_print_state)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (env-&gt;<span class="built_in">log</span>.level &amp; BPF_LOG_LEVEL2)</span><br><span class="line">				verbose(env, <span class="string">&quot;%d:&quot;</span>, env-&gt;insn_idx);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				verbose(env, <span class="string">&quot;\nfrom %d to %d%s:&quot;</span>,</span><br><span class="line">					env-&gt;prev_insn_idx, env-&gt;insn_idx,</span><br><span class="line">					env-&gt;cur_state-&gt;speculative ?</span><br><span class="line">					<span class="string">&quot; (speculative execution)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">// 打印 verifer 的所有寄存器状态</span></span><br><span class="line">			print_verifier_state(env, state-&gt;frame[state-&gt;curframe]);</span><br><span class="line">			do_print_state = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (env-&gt;<span class="built_in">log</span>.level &amp; BPF_LOG_LEVEL) &#123;</span><br><span class="line">			<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn_cbs</span> <span class="title">cbs</span> =</span> &#123;</span><br><span class="line">				.cb_call	= disasm_kfunc_name,</span><br><span class="line">				.cb_print	= verbose,</span><br><span class="line">				.private_data	= env,</span><br><span class="line">			&#125;;</span><br><span class="line">            <span class="comment">// 打印原来的 bpf 程序的代码，根据 insn_idx 找到代码</span></span><br><span class="line">			verbose_linfo(env, env-&gt;insn_idx, <span class="string">&quot;; &quot;</span>);</span><br><span class="line">			verbose(env, <span class="string">&quot;%d: &quot;</span>, env-&gt;insn_idx);</span><br><span class="line">            <span class="comment">// 打印 bpf 汇编指令</span></span><br><span class="line">			print_bpf_insn(&amp;cbs, insn, env-&gt;allow_ptr_leaks);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到有两种指令比如，26 序号有两条指令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">26: R0_w=inv(id=0) R1_w=map_ptr(id=0,off=0,ks=4,vs=8,imm=0) R2_w=fp-4 R3_w=fp0 R6=inv(id=2) R7=invP0 R10=fp0 fp-8=mmmm???? fp-16_w=mmmmmmmm</span><br><span class="line">26: (07) r3 += -16</span><br></pre></td></tr></table></figure>

<p>其中大写寄存器的是 verifier state，其相关的内容在 <code>kernel/bpf/verifier.c</code>，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bpf/verifier.c</span></span><br><span class="line"><span class="comment">/* string representation of &#x27;enum bpf_reg_type&#x27; */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> reg_type_str[] = &#123;</span><br><span class="line">	[NOT_INIT]		= <span class="string">&quot;?&quot;</span>,</span><br><span class="line">	[SCALAR_VALUE]		= <span class="string">&quot;inv&quot;</span>,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> slot_type_char[] = &#123;</span><br><span class="line">	[STACK_INVALID]	= <span class="string">&#x27;?&#x27;</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">print_verifier_state</span><span class="params">(<span class="keyword">struct</span> bpf_verifier_env *env,</span></span><br><span class="line"><span class="params">				 <span class="type">const</span> <span class="keyword">struct</span> bpf_func_state *state)</span>;</span><br></pre></td></tr></table></figure>

<p>小写的是 指令汇编代码，相关内容在，在 kernel&#x2F;bpf&#x2F;disasm.c 里。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/bpf/disasm.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_bpf_insn</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> bpf_insn_cbs *cbs,</span></span><br><span class="line"><span class="params">		    <span class="type">const</span> <span class="keyword">struct</span> bpf_insn *insn,</span></span><br><span class="line"><span class="params">		    <span class="type">bool</span> allow_ptr_leaks)</span>;</span><br></pre></td></tr></table></figure>



<h2 id="examples"><a href="#examples" class="headerlink" title="examples"></a>examples</h2><p>编译命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clang \</span><br><span class="line">-target bpf \</span><br><span class="line">-D __TARGET_ARCH_x86 \</span><br><span class="line">-Wall \</span><br><span class="line">-O2 -g -o bpf_test_3.bpf.o -c bpf_test_3.bpf.c</span><br></pre></td></tr></table></figure>

<p>Load:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bpftool prog load -d bpf_test_3.bpf.o /sys/fs/bpf/hello3</span><br></pre></td></tr></table></figure>

<h3 id="exp1-bound-check"><a href="#exp1-bound-check" class="headerlink" title="exp1 bound check"></a>exp1 bound check</h3><p>我们从一个 bpf verifier load 失败的例子来看看怎么分析 bpf load 失败（怎么看汇编和看寄存器状态）</p>
<p>这个例子来自 <a target="_blank" rel="noopener" href="https://view.officeapps.live.com/op/view.aspx?src=https://ebpftravel.com/uploads/main/3_YRQ_linux_tracing_system_analysis.pptx">国内 ebpf 大会的例子</a> ，当时看了印象深刻，于是拿过来研究一番。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vmlinux.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_core_read.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_tracing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SIZE 12</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_msg_t</span> &#123;</span></span><br><span class="line">   <span class="type">char</span> message[<span class="number">12</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    __uint(type, BPF_MAP_TYPE_HASH);</span><br><span class="line">    __uint(max_entries, <span class="number">10240</span>);</span><br><span class="line">    __type(key, u32);</span><br><span class="line">    __type(value, <span class="keyword">struct</span> <span class="type">user_msg_t</span>);</span><br><span class="line">&#125; array_map <span class="title function_">SEC</span><span class="params">(<span class="string">&quot;.maps&quot;</span>)</span>;</span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;kprobe/do_unlinkat&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">BPF_KPROBE</span><span class="params">(do_unlinkat, <span class="type">int</span> dfd, <span class="keyword">struct</span> filename *name)</span></span><br><span class="line">&#123;</span><br><span class="line">	u32 key = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_msg_t</span> *<span class="title">userd</span> =</span> bpf_map_lookup_elem(&amp;array_map, &amp;key);</span><br><span class="line">	<span class="keyword">if</span> (userd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> pos = bpf_get_smp_processor_id();;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos &lt; MAX_SIZE)&#123;</span><br><span class="line">		userd-&gt;message[pos] = <span class="number">1</span>;</span><br><span class="line">		pos += <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// bpf_printk(&quot;debug %d %d %d\n&quot;, bpf_get_current_pid_tgid() &gt;&gt; 32,</span></span><br><span class="line">	<span class="comment">// bpf_get_current_pid_tgid(), userd-&gt;message[1]);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pos &lt; MAX_SIZE)</span><br><span class="line">		userd-&gt;message[pos] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> LICENSE[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;Dual BSD/GPL&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>failed to load</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">-- BEGIN PROG LOAD LOG --</span><br><span class="line">func#0 @0</span><br><span class="line">R1 type=ctx expected=fp</span><br><span class="line">0: R1=ctx(id=0,off=0,imm=0) R10=fp0</span><br><span class="line">; int BPF_KPROBE(do_unlinkat, int dfd, struct filename *name)</span><br><span class="line">0: (b7) r1 = 0</span><br><span class="line">1: R1_w=inv0 R10=fp0</span><br><span class="line">; u32 key = 0;</span><br><span class="line">1: (63) *(u32 *)(r10 -4) = r1</span><br><span class="line">last_idx 1 first_idx 0</span><br><span class="line">regs=2 stack=0 before 0: (b7) r1 = 0</span><br><span class="line">2: R1_w=invP0 R10=fp0 fp-8=0000????</span><br><span class="line">2: (bf) r2 = r10</span><br><span class="line">3: R1_w=invP0 R2_w=fp0 R10=fp0 fp-8=0000????</span><br><span class="line">; </span><br><span class="line">3: (07) r2 += -4</span><br><span class="line">4: R1_w=invP0 R2_w=fp-4 R10=fp0 fp-8=0000????</span><br><span class="line">; struct user_msg_t *userd = bpf_map_lookup_elem(&amp;array_map, &amp;key);</span><br><span class="line">4: (18) r1 = 0xffff9382ed4bc000</span><br><span class="line">6: R1_w=map_ptr(id=0,off=0,ks=4,vs=12,imm=0) R2_w=fp-4 R10=fp0 fp-8=0000????</span><br><span class="line">6: (85) call bpf_map_lookup_elem#1</span><br><span class="line">7: R0_w=map_value_or_null(id=1,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">7: (bf) r6 = r0</span><br><span class="line">8: R0_w=map_value_or_null(id=1,off=0,ks=4,vs=12,imm=0) R6_w=map_value_or_null(id=1,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; if (userd == NULL) &#123;</span><br><span class="line">8: (15) if r6 == 0x0 goto pc+15</span><br><span class="line"> R0_w=map_value(id=0,off=0,ks=4,vs=12,imm=0) R6_w=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">9: R0_w=map_value(id=0,off=0,ks=4,vs=12,imm=0) R6_w=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; unsigned int pos = bpf_get_smp_processor_id();;</span><br><span class="line">9: (85) call bpf_get_smp_processor_id#8</span><br><span class="line">10: R0=inv(id=0) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">10: (bf) r2 = r0</span><br><span class="line">11: R0=inv(id=2) R2_w=inv(id=2) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">11: (67) r2 &lt;&lt;= 32</span><br><span class="line">12: R0=inv(id=2) R2_w=inv(id=0,smax_value=9223372032559808512,umax_value=18446744069414584320,var_off=(0x0; 0xffffffff00000000),s32_min_value=0,s32_max_value=0,u32_max_value=0) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">12: (77) r2 &gt;&gt;= 32</span><br><span class="line">13: R0=inv(id=2) R2_w=inv(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; if (pos &lt; MAX_SIZE)&#123;</span><br><span class="line">13: (25) if r2 &gt; 0xb goto pc+10</span><br><span class="line">---</span><br><span class="line"> R0=inv(id=2) R2_w=inv(id=0,umax_value=11,var_off=(0x0; 0xf)) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">---</span><br><span class="line">14: R0=inv(id=2) R2_w=inv(id=0,umax_value=11,var_off=(0x0; 0xf)) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; userd-&gt;message[pos] = 1;</span><br><span class="line">14: (bf) r3 = r6</span><br><span class="line">15: R0=inv(id=2) R2_w=inv(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,imm=0) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">15: (0f) r3 += r2</span><br><span class="line">last_idx 15 first_idx 10</span><br><span class="line">regs=4 stack=0 before 14: (bf) r3 = r6</span><br><span class="line">regs=4 stack=0 before 13: (25) if r2 &gt; 0xb goto pc+10</span><br><span class="line">regs=4 stack=0 before 12: (77) r2 &gt;&gt;= 32</span><br><span class="line">regs=4 stack=0 before 11: (67) r2 &lt;&lt;= 32</span><br><span class="line">regs=4 stack=0 before 10: (bf) r2 = r0</span><br><span class="line"> R0_rw=invP(id=0) R6_rw=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">parent didn&#x27;t have regs=1 stack=0 marks</span><br><span class="line">last_idx 9 first_idx 0</span><br><span class="line">regs=1 stack=0 before 9: (85) call bpf_get_smp_processor_id#8</span><br><span class="line">16: R0=inv(id=2) R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">16: (b7) r1 = 1</span><br><span class="line">17: R0=inv(id=2) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; userd-&gt;message[pos] = 1;</span><br><span class="line">17: (73) *(u8 *)(r3 +0) = r1</span><br><span class="line"> R0=inv(id=2) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">18: R0=inv(id=2) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; if (pos &lt; MAX_SIZE)</span><br><span class="line">18: (15) if r2 == 0xb goto pc+5</span><br><span class="line"> R0=inv(id=2) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????1</span><br><span class="line">19: R0=inv(id=2) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; pos += 1;</span><br><span class="line">19: (07) r0 += 1</span><br><span class="line">20: R0_w=inv(id=0) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">; userd-&gt;message[pos] = 1;</span><br><span class="line">20: (67) r0 &lt;&lt;= 32</span><br><span class="line">21: R0_w=inv(id=0,smax_value=9223372032559808512,umax_value=18446744069414584320,var_off=(0x0; 0xffffffff00000000),s32_min_value=0,s32_max_value=0,u32_max_value=0) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">21: (77) r0 &gt;&gt;= 32</span><br><span class="line">22: R0_w=inv(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">22: (0f) r6 += r0</span><br><span class="line">last_idx 22 first_idx 10</span><br><span class="line">regs=1 stack=0 before 21: (77) r0 &gt;&gt;= 32</span><br><span class="line">regs=1 stack=0 before 20: (67) r0 &lt;&lt;= 32</span><br><span class="line">regs=1 stack=0 before 19: (07) r0 += 1</span><br><span class="line">regs=1 stack=0 before 18: (15) if r2 == 0xb goto pc+5</span><br><span class="line">regs=1 stack=0 before 17: (73) *(u8 *)(r3 +0) = r1</span><br><span class="line">regs=1 stack=0 before 16: (b7) r1 = 1</span><br><span class="line">regs=1 stack=0 before 15: (0f) r3 += r2</span><br><span class="line">regs=1 stack=0 before 14: (bf) r3 = r6</span><br><span class="line">regs=1 stack=0 before 13: (25) if r2 &gt; 0xb goto pc+10</span><br><span class="line">regs=1 stack=0 before 12: (77) r2 &gt;&gt;= 32</span><br><span class="line">regs=1 stack=0 before 11: (67) r2 &lt;&lt;= 32</span><br><span class="line">regs=1 stack=0 before 10: (bf) r2 = r0</span><br><span class="line"> R0_rw=invP(id=0) R6_rw=map_value(id=0,off=0,ks=4,vs=12,imm=0) R10=fp0 fp-8=mmmm????</span><br><span class="line">parent already had regs=1 stack=0 marks</span><br><span class="line">23: R0_w=invP(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R10=fp0 fp-8=mmmm????</span><br><span class="line">; userd-&gt;message[pos] = 1;</span><br><span class="line">23: (73) *(u8 *)(r6 +0) = r1</span><br><span class="line">---</span><br><span class="line"> R0_w=invP(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R1_w=inv1 R2_w=invP(id=0,umax_value=11,var_off=(0x0; 0xf)) R3_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=11,var_off=(0x0; 0xf),s32_max_value=15,u32_max_value=15) R6_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R10=fp0 fp-8=mmmm????</span><br><span class="line">R6 unbounded memory access, make sure to bounds check any such access</span><br><span class="line">---</span><br><span class="line">verification time 243 usec</span><br><span class="line">stack depth 4</span><br><span class="line">processed 23 insns (limit 1000000) max_states_per_insn 0 total_states 1 peak_states 1 mark_read 1</span><br><span class="line">-- END PROG LOAD LOG --</span><br></pre></td></tr></table></figure>

<p>assembly code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~/proj/learning-ebpf/scratch (main ✗) llvm-objdump-14 -S bpf_test.bpf.o</span><br><span class="line"></span><br><span class="line">bpf_test.bpf.o: file format elf64-bpf</span><br><span class="line"></span><br><span class="line">Disassembly of section kprobe/do_unlinkat:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;do_unlinkat&gt;:</span><br><span class="line">; int BPF_KPROBE(do_unlinkat, int dfd, struct filename *name)</span><br><span class="line">       0:       b7 01 00 00 00 00 00 00 r1 = 0</span><br><span class="line">;       u32 key = 0;</span><br><span class="line">       1:       63 1a fc ff 00 00 00 00 *(u32 *)(r10 - 4) = r1</span><br><span class="line">       2:       bf a2 00 00 00 00 00 00 r2 = r10</span><br><span class="line">       3:       07 02 00 00 fc ff ff ff r2 += -4</span><br><span class="line">;       struct user_msg_t *userd = bpf_map_lookup_elem(&amp;array_map, &amp;key);</span><br><span class="line">       4:       18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll</span><br><span class="line">       6:       85 00 00 00 01 00 00 00 call 1</span><br><span class="line">       7:       bf 06 00 00 00 00 00 00 r6 = r0</span><br><span class="line">;       if (userd == NULL) &#123;</span><br><span class="line">       8:       15 06 0f 00 00 00 00 00 if r6 == 0 goto +15 &lt;LBB0_4&gt;</span><br><span class="line">;       unsigned int pos = bpf_get_smp_processor_id();;</span><br><span class="line">       9:       85 00 00 00 08 00 00 00 call 8</span><br><span class="line">      10:       bf 02 00 00 00 00 00 00 r2 = r0</span><br><span class="line">      11:       67 02 00 00 20 00 00 00 r2 &lt;&lt;= 32</span><br><span class="line">      12:       77 02 00 00 20 00 00 00 r2 &gt;&gt;= 32</span><br><span class="line">;       if (pos &lt; MAX_SIZE)&#123;</span><br><span class="line">      13:       25 02 0a 00 0b 00 00 00 if r2 &gt; 11 goto +10 &lt;LBB0_4&gt;</span><br><span class="line">;               userd-&gt;message[pos] = 1;</span><br><span class="line">      14:       bf 63 00 00 00 00 00 00 r3 = r6</span><br><span class="line">      15:       0f 23 00 00 00 00 00 00 r3 += r2</span><br><span class="line">      16:       b7 01 00 00 01 00 00 00 r1 = 1</span><br><span class="line">      17:       73 13 00 00 00 00 00 00 *(u8 *)(r3 + 0) = r1</span><br><span class="line">;       if (pos &lt; MAX_SIZE)</span><br><span class="line">      18:       15 02 05 00 0b 00 00 00 if r2 == 11 goto +5 &lt;LBB0_4&gt;</span><br><span class="line">;               pos += 1;</span><br><span class="line">      19:       07 00 00 00 01 00 00 00 r0 += 1</span><br><span class="line">;               userd-&gt;message[pos] = 1;</span><br><span class="line">      20:       67 00 00 00 20 00 00 00 r0 &lt;&lt;= 32</span><br><span class="line">      21:       77 00 00 00 20 00 00 00 r0 &gt;&gt;= 32</span><br><span class="line">      22:       0f 06 00 00 00 00 00 00 r6 += r0</span><br><span class="line">      23:       73 16 00 00 00 00 00 00 *(u8 *)(r6 + 0) = r1</span><br><span class="line"></span><br><span class="line">00000000000000c0 &lt;LBB0_4&gt;:</span><br><span class="line">; int BPF_KPROBE(do_unlinkat, int dfd, struct filename *name)</span><br><span class="line">      24:       b7 00 00 00 00 00 00 00 r0 = 0</span><br><span class="line">      25:       95 00 00 00 00 00 00 00 exit</span><br></pre></td></tr></table></figure>

<p>从 log 来看其实比较直观，就是说 R6 的边界检查失败了。R6 的状态为 <code>R6_w=map_value(id=0,off=0,ks=4,vs=12,umax_value=4294967295,var_off=(0x0; 0xffffffff)) </code> ，它的最大值为 4294967295，比 map 的 max_size 大，</p>
<ul>
<li>这里我们研究一下第一段汇编代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">; int BPF_KPROBE(do_unlinkat, int dfd, struct filename *name)</span><br><span class="line">       0:	b7 01 00 00 00 00 00 00	r1 = 0</span><br><span class="line">; 	u32 key = 0;</span><br><span class="line">       1:	63 1a fc ff 00 00 00 00	*(u32 *)(r10 - 4) = r1</span><br><span class="line">       2:	bf a2 00 00 00 00 00 00	r2 = r10</span><br><span class="line">       3:	07 02 00 00 fc ff ff ff	r2 += -4</span><br><span class="line"></span><br><span class="line">; int BPF_KPROBE(do_unlinkat, int dfd, struct filename *name)</span><br><span class="line">0: (b7) r1 = 0</span><br><span class="line">1: R1_w=inv0 R10=fp0</span><br><span class="line">; u32 key = 0;</span><br><span class="line">1: (63) *(u32 *)(r10 -4) = r1</span><br><span class="line">last_idx 1 first_idx 0</span><br><span class="line">regs=2 stack=0 before 0: (b7) r1 = 0</span><br><span class="line">2: R1_w=invP0 R10=fp0 fp-8=0000????</span><br><span class="line">2: (bf) r2 = r10</span><br><span class="line">3: R1_w=invP0 R2_w=fp0 R10=fp0 fp-8=0000????</span><br><span class="line">;</span><br><span class="line">3: (07) r2 += -4</span><br><span class="line">4: R1_w=invP0 R2_w=fp-4 R10=fp0 fp-8=0000????</span><br></pre></td></tr></table></figure>

<ol>
<li><code>r1=0</code> 之后显示，r1 寄存器的状态为 <code>R1_w=inv0</code>表示 R1刚被写入，是一个 scalar类型的值，可以看到首先赋值给 r1&#x3D;1。</li>
<li><code>*(u32 *)(r10 -4) = r1</code> 需要将 r1 的值 0 赋值到给一个栈上的地址。</li>
<li><code>r2 = r10</code>  和 <code>r2 += -4</code>将 r10（栈指针）赋值给 r2，将 r2 指向该栈上的值</li>
</ol>
<ul>
<li>接着第二句 <code>;       struct user_msg_t *userd = bpf_map_lookup_elem(&amp;array_map, &amp;key);</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4:       18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll</span><br><span class="line">6:       85 00 00 00 01 00 00 00 call 1</span><br><span class="line">7:       bf 06 00 00 00 00 00 00 r6 = r0</span><br></pre></td></tr></table></figure>

<ol>
<li><code>r1 = 0 ll</code> 可以看到，在这一句中，verifier log 中对应的语句是 <code> r1 = 0xffff9382ed4bc000</code>，这个是 array_map 地址。从 verifer log 中可以看到这个语句之后，寄存器的类型是 map_ptr。因为上面的汇编代码是 llvm-objdump 的结果，所以可能还没有 load 进内核的时候，其实是不知道 map 的地址的。</li>
<li>0x85 是 helper function call，call 1 是在调用 bpf_map_lookup_elem，这个  id 对应了 <code>include/uapi/linux/bpf.h</code> 里的 __BPF_FUNC_MAPPER 宏。</li>
<li>最后是 r6 存一下 helper function 的返回值</li>
</ol>
<ul>
<li>接着3,4句</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">;       if (userd == NULL) &#123;</span><br><span class="line">       8:       15 06 0f 00 00 00 00 00 if r6 == 0 goto +15 &lt;LBB0_4&gt;</span><br><span class="line">;       unsigned int pos = bpf_get_smp_processor_id();;</span><br><span class="line">       9:       85 00 00 00 08 00 00 00 call 8</span><br><span class="line">      10:       bf 02 00 00 00 00 00 00 r2 = r0</span><br><span class="line">      11:       67 02 00 00 20 00 00 00 r2 &lt;&lt;= 32</span><br><span class="line">      12:       77 02 00 00 20 00 00 00 r2 &gt;&gt;= 32</span><br></pre></td></tr></table></figure>

<ol>
<li>这里调用了 8 号辅助函数 <code>bpf_get_smp_processor_id</code>，在之后用 r2 来缓存了 r0，不过为什么要做这样一个 移位的操作，不是很懂，总之是编译器的行为</li>
</ol>
<ul>
<li>再接着，第一次判断 MAX_SIZE 的关系，对应代码为</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pos &lt; MAX_SIZE)&#123;</span><br><span class="line">	userd-&gt;message[pos] = <span class="number">1</span>;</span><br><span class="line">	pos += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">;       if (pos &lt; MAX_SIZE)&#123;</span><br><span class="line">      13:       25 02 0a 00 0b 00 00 00 if r2 &gt; 11 goto +10 &lt;LBB0_4&gt;</span><br><span class="line">;               userd-&gt;message[pos] = 1;</span><br><span class="line">      14:       bf 63 00 00 00 00 00 00 r3 = r6</span><br><span class="line">      15:       0f 23 00 00 00 00 00 00 r3 += r2</span><br><span class="line">      16:       b7 01 00 00 01 00 00 00 r1 = 1</span><br><span class="line">      17:       73 13 00 00 00 00 00 00 *(u8 *)(r3 + 0) = r1</span><br></pre></td></tr></table></figure>

<ol>
<li>这段代码对移位后的 r0 判断了大小，然后对 map 地址 执行了写操作。</li>
<li>这里没有 pos+&#x3D;1 的操作</li>
<li>r3 的范围来自 r2，r2 的状态为 <code> R2_w=inv(id=0,umax_value=11,var_off=(0x0; 0xf))</code></li>
</ol>
<ul>
<li>最后，判断 pos 和 MAX_SIZE 的关系，对应代码为</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pos &lt; MAX_SIZE)</span><br><span class="line">	userd-&gt;message[pos] = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">;       if (pos &lt; MAX_SIZE)</span><br><span class="line">      18:       15 02 05 00 0b 00 00 00 if r2 == 11 goto +5 &lt;LBB0_4&gt;</span><br><span class="line">;               pos += 1;</span><br><span class="line">      19:       07 00 00 00 01 00 00 00 r0 += 1</span><br><span class="line">;               userd-&gt;message[pos] = 1;</span><br><span class="line">      20:       67 00 00 00 20 00 00 00 r0 &lt;&lt;= 32</span><br><span class="line">      21:       77 00 00 00 20 00 00 00 r0 &gt;&gt;= 32</span><br><span class="line">      22:       0f 06 00 00 00 00 00 00 r6 += r0</span><br><span class="line">      23:       73 16 00 00 00 00 00 00 *(u8 *)(r6 + 0) = r1</span><br></pre></td></tr></table></figure>

<ol>
<li>这一段首先判断了 pos 是不是等于 11，因为 pos+&#x3D;1 这个逻辑是在上一个 if 中的，经过编译器编译，放到这个逻辑里面，并且加了个判断</li>
<li>这里最终访问 map 的寄存器来自于 r0，为什么不用 r2 呢，不知道编译器怎么想的</li>
</ol>
<h3 id="exp2-pkt-access"><a href="#exp2-pkt-access" class="headerlink" title="exp2: pkt access"></a>exp2: pkt access</h3><p>由某篇的博客变形而来：<a target="_blank" rel="noopener" href="https://hechao.li/2019/06/20/An-Invalid-bpf_context-Access-Bug/%EF%BC%8C%E4%BB%96%E7%9A%84">https://hechao.li/2019/06/20/An-Invalid-bpf_context-Access-Bug/，他的</a> kernel 似乎是 4.x 的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">&quot;sockops&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">func2</span><span class="params">(<span class="keyword">struct</span> bpf_sock_ops* skops)</span> &#123;</span><br><span class="line">  __u64 byte0 = skops-&gt;remote_ip6[<span class="number">0</span>];</span><br><span class="line">  __u64 byte1 = skops-&gt;remote_ip6[<span class="number">1</span>];</span><br><span class="line">  <span class="comment">// __u64 byte2 = skops-&gt;remote_ip6[2];</span></span><br><span class="line">  <span class="comment">// __u64 byte3 = skops-&gt;remote_ip6[3];</span></span><br><span class="line"></span><br><span class="line">  __u64 addr_hi = (byte1 &lt;&lt; <span class="number">32</span>) | byte0;</span><br><span class="line">  <span class="comment">// __u64 addr_lo = (byte3 &lt;&lt; 32) | byte2;</span></span><br><span class="line"></span><br><span class="line">  bpf_trace_printk(<span class="string">&quot;remote_ip: %llu\n&quot;</span>, addr_hi);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> -- BEGIN PROG LOAD LOG --</span><br><span class="line">func#0 @0</span><br><span class="line">0: R1=ctx(id=0,off=0,imm=0) R10=fp0</span><br><span class="line">; bpf_trace_printk(&quot;remote_ip: %llu\n&quot;, addr_hi);</span><br><span class="line">0: (61) r2 = *(u32 *)(r1 +32)</span><br><span class="line">1: R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R10=fp0</span><br><span class="line">1: (18) r1 = 0xffff9381bb0ff910</span><br><span class="line">3: R1_w=map_value(id=0,off=0,ks=4,vs=17,imm=0) R2_w=inv(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R10=fp0</span><br><span class="line">3: (85) call bpf_trace_printk#6</span><br><span class="line"> R1_w=map_value(id=0,off=0,ks=4,vs=17,imm=0) R2_w=inv(id=0,umax_value=4294967295,var_off=(0x0; 0xffffffff)) R10=fp0</span><br><span class="line">invalid access to map value, value_size=17 off=0 size=0</span><br><span class="line">R1 min value is outside of the allowed memory range</span><br><span class="line">verification time 312 usec</span><br><span class="line">stack depth 0</span><br><span class="line">processed 3 insns (limit 1000000) max_states_per_insn 0 total_states 0 peak_states 0 mark_read 0</span><br><span class="line">-- END PROG LOAD LOG --</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~/proj/learning-ebpf/scratch (main ✗) llvm-objdump-14 -S bpf_test_2.bpf.o</span><br><span class="line"></span><br><span class="line">bpf_test_2.bpf.o:       file format elf64-bpf</span><br><span class="line"></span><br><span class="line">Disassembly of section sockops:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;func2&gt;:</span><br><span class="line">;   bpf_trace_printk(&quot;remote_ip: %llu\n&quot;, addr_hi);</span><br><span class="line">       0:       61 12 20 00 00 00 00 00 r2 = *(u32 *)(r1 + 32)</span><br><span class="line">       1:       18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll</span><br><span class="line">       3:       85 00 00 00 06 00 00 00 call 6</span><br><span class="line">;   return 0;</span><br><span class="line">       4:       b7 00 00 00 00 00 00 00 r0 = 0</span><br><span class="line">       5:       95 00 00 00 00 00 00 00 exit</span><br></pre></td></tr></table></figure>

<p>编译器直接给优化到直接算出 r2 了，但 还是挂了</p>
<h3 id="exp3-kprobe-pt-regs"><a href="#exp3-kprobe-pt-regs" class="headerlink" title="exp3: kprobe pt_regs"></a>exp3: kprobe pt_regs</h3><p>从 <a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/issues/751">https://github.com/iovisor/bcc/issues/751</a> 而来，我改写成了 libbpf 版的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vmlinux.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_core_read.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_tracing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> LICENSE[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;Dual BSD/GPL&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dummy1</span><span class="params">(<span class="keyword">struct</span> pt_regs *ctx, <span class="type">void</span> *dest, <span class="type">size_t</span> len)</span> &#123;          </span><br><span class="line">	<span class="keyword">switch</span>(ctx-&gt;ip) &#123;                                                             </span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x55e29a4ce2a4</span>ULL: *((<span class="type">uint64_t</span> *)dest) = (<span class="type">uint64_t</span>)ctx-&gt;si; <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">		<span class="keyword">case</span> <span class="number">0x55e29a4ce7ab</span>ULL: *((<span class="type">uint64_t</span> *)dest) = (<span class="type">uint64_t</span>)ctx-&gt;bp; <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">	&#125;                                                                             </span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;                                                                    </span><br><span class="line">&#125;                  </span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;kprobe/__x64_sys_getpgid&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">do_start</span><span class="params">(<span class="keyword">struct</span> pt_regs *ctx)</span>                                               </span><br><span class="line">&#123;                                                                               </span><br><span class="line">        u64 arg1 = <span class="number">0</span>;         </span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ret2 = dummy1(ctx, &amp;arg1, <span class="keyword">sizeof</span>(arg1));                                        </span><br><span class="line">        <span class="keyword">if</span> (arg1 != <span class="number">0</span>) &#123;                                                        </span><br><span class="line">            bpf_trace_printk(<span class="string">&quot;Hi 2, %d\n&quot;</span>, ret2);  </span><br><span class="line">        &#125;                                                                       </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;                                                               </span><br><span class="line">&#125;              </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">-- BEGIN PROG LOAD LOG --</span><br><span class="line">func#0 @0</span><br><span class="line">R1 type=ctx expected=fp</span><br><span class="line">0: R1=ctx(id=0,off=0,imm=0) R10=fp0</span><br><span class="line">; switch(ctx-&gt;ip) &#123;                                                             </span><br><span class="line">0: (79) r2 = *(u64 *)(r1 +128)</span><br><span class="line">1: R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0) R10=fp0</span><br><span class="line">1: (18) r3 = 0x55e29a4ce7ab</span><br><span class="line">3: R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0) R3_w=inv94431739701163 R10=fp0</span><br><span class="line">; switch(ctx-&gt;ip) &#123;                                                             </span><br><span class="line">3: (1d) if r2 == r3 goto pc+5</span><br><span class="line"> R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0) R3_w=inv94431739701163 R10=fp0</span><br><span class="line">4: R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0) R3_w=inv94431739701163 R10=fp0</span><br><span class="line">4: (18) r3 = 0x55e29a4ce2a4</span><br><span class="line">6: R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0) R3_w=inv94431739699876 R10=fp0</span><br><span class="line">6: (5d) if r2 != r3 goto pc+10</span><br><span class="line"> R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0,umin_value=94431739699876,umax_value=94431739699876,var_off=(0x55e200000000; 0xffffffff)) R3_w=inv94431739699876 R10=fp0</span><br><span class="line">7: R1=ctx(id=0,off=0,imm=0) R2_w=inv(id=0,umin_value=94431739699876,umax_value=94431739699876,var_off=(0x55e200000000; 0xffffffff)) R3_w=inv94431739699876 R10=fp0</span><br><span class="line">7: (b7) r2 = 104</span><br><span class="line">8: R1=ctx(id=0,off=0,imm=0) R2_w=inv104 R3_w=inv94431739699876 R10=fp0</span><br><span class="line">8: (05) goto pc+1</span><br><span class="line">10: R1=ctx(id=0,off=0,imm=0) R2=inv104 R3=inv94431739699876 R10=fp0</span><br><span class="line">10: (0f) r1 += r2</span><br><span class="line">last_idx 10 first_idx 10</span><br><span class="line"> R1_r=ctx(id=0,off=0,imm=0) R2_rw=invP104 R3_w=inv94431739699876 R10=fp0</span><br><span class="line">parent didn&#x27;t have regs=4 stack=0 marks</span><br><span class="line">last_idx 8 first_idx 0</span><br><span class="line">regs=4 stack=0 before 8: (05) goto pc+1</span><br><span class="line">regs=4 stack=0 before 7: (b7) r2 = 104</span><br><span class="line">11: R1_w=ctx(id=0,off=104,imm=0) R2=invP104 R3=inv94431739699876 R10=fp0</span><br><span class="line">; </span><br><span class="line">11: (79) r1 = *(u64 *)(r1 +0)</span><br><span class="line">dereference of modified ctx ptr R1 off=104 disallowed</span><br><span class="line">verification time 102 usec</span><br><span class="line">stack depth 0</span><br><span class="line">processed 9 insns (limit 1000000) max_states_per_insn 0 total_states 1 peak_states 1 mark_read 1</span><br><span class="line">-- END PROG LOAD LOG --</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">~/proj/learning-ebpf/scratch (main ✗) llvm-objdump-14 -S bpf_test_3.bpf.o</span><br><span class="line"></span><br><span class="line">bpf_test_3.bpf.o:       file format elf64-bpf</span><br><span class="line"></span><br><span class="line">Disassembly of section kprobe/__x64_sys_getpgid:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;do_start&gt;:</span><br><span class="line">;       switch(ctx-&gt;ip) &#123;                                                             </span><br><span class="line">       0:       79 12 80 00 00 00 00 00 r2 = *(u64 *)(r1 + 128)</span><br><span class="line">       1:       18 03 00 00 ab e7 4c 9a 00 00 00 00 e2 55 00 00 r3 = 94431739701163 ll</span><br><span class="line">       3:       1d 32 05 00 00 00 00 00 if r2 == r3 goto +5 &lt;LBB0_3&gt;</span><br><span class="line">       4:       18 03 00 00 a4 e2 4c 9a 00 00 00 00 e2 55 00 00 r3 = 94431739699876 ll</span><br><span class="line">;       switch(ctx-&gt;ip) &#123;                                                             </span><br><span class="line">       6:       5d 32 0a 00 00 00 00 00 if r2 != r3 goto +10 &lt;LBB0_6&gt;</span><br><span class="line">       7:       b7 02 00 00 68 00 00 00 r2 = 104</span><br><span class="line">       8:       05 00 01 00 00 00 00 00 goto +1 &lt;LBB0_4&gt;</span><br><span class="line"></span><br><span class="line">0000000000000048 &lt;LBB0_3&gt;:</span><br><span class="line">       9:       b7 02 00 00 20 00 00 00 r2 = 32</span><br><span class="line"></span><br><span class="line">0000000000000050 &lt;LBB0_4&gt;:</span><br><span class="line">      10:       0f 21 00 00 00 00 00 00 r1 += r2</span><br><span class="line">      11:       79 11 00 00 00 00 00 00 r1 = *(u64 *)(r1 + 0)</span><br><span class="line">;         if (arg1 != 0) &#123;                                                        </span><br><span class="line">      12:       15 01 04 00 00 00 00 00 if r1 == 0 goto +4 &lt;LBB0_6&gt;</span><br><span class="line">;             bpf_trace_printk(&quot;Hi 2, %d\n&quot;, ret2);  </span><br><span class="line">      13:       18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll</span><br><span class="line">      15:       b7 02 00 00 00 00 00 00 r2 = 0</span><br><span class="line">      16:       85 00 00 00 06 00 00 00 call 6</span><br><span class="line"></span><br><span class="line">0000000000000088 &lt;LBB0_6&gt;:</span><br><span class="line">;         return 0;                                                               </span><br><span class="line">      17:       b7 00 00 00 00 00 00 00 r0 = 0</span><br><span class="line">      18:       95 00 00 00 00 00 00 00 exit</span><br><span class="line">~/proj/learning-ebpf/scratch (main ✗) </span><br></pre></td></tr></table></figure>

<h3 id="exp4-clang-O0-vs-O2"><a href="#exp4-clang-O0-vs-O2" class="headerlink" title="exp4: clang O0 vs. O2"></a>exp4: clang O0 vs. O2</h3><p>O2 可以 load，O0 不可以</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vmlinux.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_helpers.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_core_read.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bpf/bpf_tracing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> LICENSE[] SEC(<span class="string">&quot;license&quot;</span>) = <span class="string">&quot;Dual BSD/GPL&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dummy2</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">	<span class="type">int</span> a1 = a+<span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> a2 = a1+<span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> a3 = a2+<span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> a4 = a3+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> a1+a2+a3+a4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SEC(<span class="string">&quot;kprobe/__x64_sys_getpgid&quot;</span>)</span><br><span class="line"><span class="type">int</span> <span class="title function_">do_start</span><span class="params">(<span class="keyword">struct</span> pt_regs *ctx)</span>                                               </span><br><span class="line">&#123;                                                                               </span><br><span class="line">        u64 arg1 = <span class="number">0</span>;         </span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> ret1 = dummy2(arg1);                                 </span><br><span class="line">		bpf_trace_printk(<span class="string">&quot;Hi 1, %d\n&quot;</span>, ret1);           </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;                                                               </span><br><span class="line">&#125;              </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-- END BTF LOAD LOG --</span><br><span class="line">libbpf: Error loading .BTF into kernel: -22. BTF is optional, ignoring.</span><br><span class="line">libbpf: map &#x27;bpf_test.data&#x27;: created successfully, fd=3</span><br><span class="line">libbpf: map &#x27;.rodata.str1.1&#x27;: created successfully, fd=4</span><br><span class="line">libbpf: prog &#x27;do_start&#x27;: added 21 insns from sub-prog &#x27;dummy2&#x27;</span><br><span class="line">libbpf: prog &#x27;do_start&#x27;: insn #5 relocated, imm 10 points to subprog &#x27;dummy2&#x27; (now at 16 offset)</span><br><span class="line">libbpf: prog &#x27;do_start&#x27;: BPF program load failed: Invalid argument</span><br><span class="line">libbpf: prog &#x27;do_start&#x27;: -- BEGIN PROG LOAD LOG --</span><br><span class="line">func#0 @0</span><br><span class="line">func#1 @16</span><br><span class="line">unknown opcode 8d</span><br><span class="line">verification time 14 usec</span><br><span class="line">stack depth 0+0</span><br><span class="line">processed 0 insns (limit 1000000) max_states_per_insn 0 total_states 0 peak_states 0 mark_read 0</span><br><span class="line">-- END PROG LOAD LOG --</span><br></pre></td></tr></table></figure>

<p>不知道为什么 O0 编译出了，unknown op code，有 callx 这种指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">~/proj/learning-ebpf/scratch (main ✗) llvm-objdump-14 -S bpf_test_3.bpf.o</span><br><span class="line"></span><br><span class="line">bpf_test_3.bpf.o:       file format elf64-bpf</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;dummy2&gt;:</span><br><span class="line">; static int dummy2(int a) &#123;</span><br><span class="line">       0:       63 1a fc ff 00 00 00 00 *(u32 *)(r10 - 4) = r1</span><br><span class="line">;       int a1 = a+1;</span><br><span class="line">       1:       61 a1 fc ff 00 00 00 00 r1 = *(u32 *)(r10 - 4)</span><br><span class="line">       2:       07 01 00 00 01 00 00 00 r1 += 1</span><br><span class="line">       3:       63 1a f8 ff 00 00 00 00 *(u32 *)(r10 - 8) = r1</span><br><span class="line">;       int a2 = a1+1;</span><br><span class="line">       4:       61 a1 f8 ff 00 00 00 00 r1 = *(u32 *)(r10 - 8)</span><br><span class="line">       5:       07 01 00 00 01 00 00 00 r1 += 1</span><br><span class="line">       6:       63 1a f4 ff 00 00 00 00 *(u32 *)(r10 - 12) = r1</span><br><span class="line">;       int a3 = a2+1;</span><br><span class="line">       7:       61 a1 f4 ff 00 00 00 00 r1 = *(u32 *)(r10 - 12)</span><br><span class="line">       8:       07 01 00 00 01 00 00 00 r1 += 1</span><br><span class="line">       9:       63 1a f0 ff 00 00 00 00 *(u32 *)(r10 - 16) = r1</span><br><span class="line">;       int a4 = a3+1;</span><br><span class="line">      10:       61 a1 f0 ff 00 00 00 00 r1 = *(u32 *)(r10 - 16)</span><br><span class="line">      11:       07 01 00 00 01 00 00 00 r1 += 1</span><br><span class="line">      12:       63 1a ec ff 00 00 00 00 *(u32 *)(r10 - 20) = r1</span><br><span class="line">;       return a1+a2+a3+a4;</span><br><span class="line">      13:       61 a0 f8 ff 00 00 00 00 r0 = *(u32 *)(r10 - 8)</span><br><span class="line">      14:       61 a1 f4 ff 00 00 00 00 r1 = *(u32 *)(r10 - 12)</span><br><span class="line">      15:       0f 10 00 00 00 00 00 00 r0 += r1</span><br><span class="line">      16:       61 a1 f0 ff 00 00 00 00 r1 = *(u32 *)(r10 - 16)</span><br><span class="line">      17:       0f 10 00 00 00 00 00 00 r0 += r1</span><br><span class="line">      18:       61 a1 ec ff 00 00 00 00 r1 = *(u32 *)(r10 - 20)</span><br><span class="line">      19:       0f 10 00 00 00 00 00 00 r0 += r1</span><br><span class="line">      20:       95 00 00 00 00 00 00 00 exit</span><br><span class="line"></span><br><span class="line">Disassembly of section kprobe/__x64_sys_getpgid:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;do_start&gt;:</span><br><span class="line">; &#123;                                                                               </span><br><span class="line">       0:       7b 1a f8 ff 00 00 00 00 *(u64 *)(r10 - 8) = r1</span><br><span class="line">       1:       b7 01 00 00 00 00 00 00 r1 = 0</span><br><span class="line">;         u64 arg1 = 0;         </span><br><span class="line">       2:       7b 1a e0 ff 00 00 00 00 *(u64 *)(r10 - 32) = r1</span><br><span class="line">       3:       7b 1a f0 ff 00 00 00 00 *(u64 *)(r10 - 16) = r1</span><br><span class="line">;               int ret1 = dummy2(arg1);                                 </span><br><span class="line">       4:       79 a1 f0 ff 00 00 00 00 r1 = *(u64 *)(r10 - 16)</span><br><span class="line">       5:       85 10 00 00 ff ff ff ff call -1</span><br><span class="line">       6:       63 0a ec ff 00 00 00 00 *(u32 *)(r10 - 20) = r0</span><br><span class="line">;               bpf_trace_printk(&quot;Hi 1, %d\n&quot;, ret1); </span><br><span class="line">       7:       18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll</span><br><span class="line">       9:       79 13 00 00 00 00 00 00 r3 = *(u64 *)(r1 + 0)</span><br><span class="line">      10:       61 a2 ec ff 00 00 00 00 r2 = *(u32 *)(r10 - 20)</span><br><span class="line">      11:       18 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r1 = 0 ll</span><br><span class="line">      13:       8d 00 00 00 03 00 00 00 callx r3</span><br><span class="line">;         return 0;                                                               </span><br><span class="line">      14:       79 a0 e0 ff 00 00 00 00 r0 = *(u64 *)(r10 - 32)</span><br><span class="line">      15:       95 00 00 00 00 00 00 00 exit</span><br><span class="line">~/proj/learning-ebpf/scratch (main ✗) </span><br></pre></td></tr></table></figure>

<p>另外，从这里也可以看出来，r1 只是参数，并不一定是 PTR_TO_CTX。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bpf-verifier-3"><span class="toc-number">1.</span> <span class="toc-text">bpf verifier (3)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3-verifier-logs"><span class="toc-number">1.1.</span> <span class="toc-text">如何理解 verifier logs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#examples"><span class="toc-number">1.2.</span> <span class="toc-text">examples</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp1-bound-check"><span class="toc-number">1.2.1.</span> <span class="toc-text">exp1 bound check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp2-pkt-access"><span class="toc-number">1.2.2.</span> <span class="toc-text">exp2: pkt access</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp3-kprobe-pt-regs"><span class="toc-number">1.2.3.</span> <span class="toc-text">exp3: kprobe pt_regs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp4-clang-O0-vs-O2"><span class="toc-number">1.2.4.</span> <span class="toc-text">exp4: clang O0 vs. O2</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://middaywords.github.io/2023/10/26/bpf-verifier-3/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&text=bpf verifier 3"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&is_video=false&description=bpf verifier 3"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=bpf verifier 3&body=Check out this article: https://middaywords.github.io/2023/10/26/bpf-verifier-3/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&title=bpf verifier 3"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&name=bpf verifier 3&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://middaywords.github.io/2023/10/26/bpf-verifier-3/&t=bpf verifier 3"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Kangjie Xu
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
